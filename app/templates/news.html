{% extends "_base.html" %}

{% block title %}Twitcher | –ù–æ–≤–æ—Å—Ç–∏{% endblock %}
{% block content %}
  <div class="max-w-6xl mx-auto mt-6 grid grid-cols-1 gap-8 p-4">

    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
    <div class="space-y-6">
      <!-- –õ–µ–Ω—Ç–∞ –Ω–æ–≤–æ—Å—Ç–µ–π -->
      <div class="space-y-4">
        <h3 class="text-xl font-semibold">–õ–µ–Ω—Ç–∞ –Ω–æ–≤–æ—Å—Ç–µ–π</h3>

        {% for post in posts %}
          <div class="bg-white border border-gray-300 p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow cursor-pointer"
               onclick="window.location.href='/posts/{{ post.id }}'">
            <div class="flex items-start gap-3">
              <img src="/static/img/default-avatar.jpg"
                   class="rounded-full"
                   alt="Avatar"
                   width="50"
                   height="50">
              <div class="flex-1">
                <div class="flex justify-between">
                  <div>
                    <a href="/feed/user/{{ post.author.id }}" class="hover:underline" onclick="event.stopPropagation()">
                      <h4 class="font-semibold">{{ post.author.first_name }} {{ post.author.last_name }}</h4>
                    </a>
                    <a href="/feed/user/{{ post.author.id }}" class="hover:underline" onclick="event.stopPropagation()">
                      <p class="text-sm text-gray-500">@{{ post.author.username }}</p>
                    </a>
                  </div>
                  <a href="/posts/{{ post.id }}" class="text-sm text-gray-400 hover:underline"
                     onclick="event.stopPropagation()">
                    {{ post.created_at.strftime('%d.%m.%Y %H:%M') }}
                  </a>
                </div>

                {% if post.reposted_from %}
                  <div class="bg-gray-50 p-3 mt-2 rounded border-l-4 border-blue-200"
                       onclick="event.stopPropagation(); window.location.href='/posts/{{ post.reposted_from.id }}'">
                    <p class="text-sm text-gray-600">
                      –†–µ–ø–æ—Å—Ç –æ—Ç {{ post.reposted_from.author.first_name }} {{ post.reposted_from.author.last_name }}
                    </p>
                    <p class="mt-1">{{ post.reposted_from.content }}</p>
                    <p class="text-xs text-gray-400 mt-1">
                      {{ post.reposted_from.created_at.strftime('%d.%m.%Y %H:%M') }}
                    </p>
                  </div>
                {% endif %}

                <p class="mt-2">{{ post.content }}</p>

                {% if post.image %}

                  <img src="{{ post.image }}" alt="Post image" class="mt-2 rounded-lg w-full">
                {% endif %}

                <div class="flex gap-4 text-sm text-gray-600 mt-3">
                  <button class="flex items-center gap-1 hover:text-red-500"
                          onclick="event.stopPropagation(); toggleLike({{ post.id }}, this)">
                    {% if user.id in post.likes|map(attribute='user_id') %}
                      <span>‚ù§Ô∏è</span> <span class="like-count">{{ post.likes_count }}</span>
                    {% else %}
                      <span>üñ§</span><span class="like-count">{{ post.likes_count }}</span>
                    {% endif %}
                  </button>
                  <a href="/posts/{{ post.id }}#comments" class="flex items-center gap-1 hover:text-blue-500"
                     onclick="event.stopPropagation()">
                    üí¨ {{ post.comments_count }}
                  </a>
                  <button class="flex items-center gap-1 hover:text-green-500"
                          onclick="event.stopPropagation(); openRepostModal({{ post.id }})">
                    ‚Üª <span class="repost-count">{{ post.reposts_count }}</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}

      </div>
    </div>
  </div>
{% endblock %}
{% block scripts %}
  <script>
      function formatDate(dateString) {
          const date = new Date(dateString);
          const options = {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
          };
          return date.toLocaleString('ru-RU', options);
      }

      document.querySelectorAll('.post-date').forEach(el => {
          el.textContent = formatDate(el.dataset.time);
      });

      document.querySelectorAll('.post-container').forEach(container => {
          container.addEventListener('click', function () {
              const postId = this.dataset.postId;
              window.location.href = `/posts/${postId}`;
          });
      });

      async function toggleLike(postId, button) {
          const likeIcon = button.querySelector('span:first-child');
          const likeCount = button.querySelector('.like-count');
          const isLiked = likeIcon.textContent === '‚ù§Ô∏è';

          try {
              const response = isLiked
                  ? await fetch(`/posts/${postId}/likes`, {method: 'DELETE'})
                  : await fetch(`/posts/${postId}/likes`, {method: 'POST'});

              if (response.ok) {
                  const result = await response.json();
                  likeIcon.textContent = isLiked ? 'üñ§' : '‚ù§Ô∏è';
                  likeCount.textContent = result.new_count;
              }
          } catch (error) {
              console.error('Error toggling like:', error);
          }
      }
  </script>
{% endblock %}